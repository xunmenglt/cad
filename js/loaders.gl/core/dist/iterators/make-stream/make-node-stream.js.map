{"version":3,"sources":["../../../src/iterators/make-stream/make-node-stream.ts"],"names":["Readable","makeNodeStream","source","options","iterator","Symbol","asyncIterator","AsyncIterableReadable","constructor","it","_iterator","_pulling","_bytesMode","objectMode","_read","size","_pull","_destroy","error","cb","throw","return","bm","r","readable","next","done","ArrayBuffer","isView","value","byteLength","push","Uint8Array"],"mappings":";AAAA,SAAQA,QAAR,QAAwC,QAAxC;;AAKA,SAASC,cAAT,CACEC,MADF,EAEEC,OAFF,EAGY;AACV,QAAMC,QAAQ,GAAGF,MAAM,CAACG,MAAM,CAACC,aAAR,CAAN,GACbJ,MAAM,CAACG,MAAM,CAACC,aAAR,CAAN,EADa,GAEbJ,MAAM,CAACG,MAAM,CAACD,QAAR,CAAN,EAFJ;AAGA,SAAO,IAAIG,qBAAJ,CAA0BH,QAA1B,EAAoCD,OAApC,CAAP;AACD;;AAED,MAAMI,qBAAN,SAAoCP,QAApC,CAA6C;AAK3CQ,EAAAA,WAAW,CAACC,EAAD,EAAiCN,OAAjC,EAA4D;AACrE,UAAMA,OAAN;;AADqE;;AAAA;;AAAA;;AAErE,SAAKO,SAAL,GAAiBD,EAAjB;AACA,SAAKE,QAAL,GAAgB,KAAhB;AACA,SAAKC,UAAL,GAAkB,CAACT,OAAD,IAAY,CAACA,OAAO,CAACU,UAAvC;AACD;;AAEU,QAALC,KAAK,CAACC,IAAD,EAA8B;AACvC,QAAI,CAAC,KAAKJ,QAAV,EAAoB;AAClB,WAAKA,QAAL,GAAgB,IAAhB;AACA,WAAKA,QAAL,GAAgB,MAAM,KAAKK,KAAL,CAAWD,IAAX,EAAiB,KAAKL,SAAtB,CAAtB;AACD;AACF;;AAEa,QAARO,QAAQ,CAACC,KAAD,EAAsBC,EAAtB,EAAoE;AAChF,QAAI,CAAC,KAAKT,SAAV,EAAqB;AACnB;AACD;;AACD,QAAIQ,KAAJ,EAAW;AAAA;;AACT,gCAAM,KAAKR,SAAX,6EAAM,gBAAgBU,KAAtB,0DAAM,4CAAwBF,KAAxB,CAAN;AACD,KAFD,MAEO;AAAA;;AACL,iCAAM,KAAKR,SAAX,8EAAM,iBAAgBW,MAAtB,0DAAM,6CAAyBH,KAAzB,CAAN;AACD;;AACDC,IAAAA,EAAE,SAAF,IAAAA,EAAE,WAAF,YAAAA,EAAE,CAAG,IAAH,CAAF;AACD;;AAGkB,QAALH,KAAK,CAACD,IAAD,EAAeN,EAAf,EAAiE;AAAA;;AAClF,UAAMa,EAAE,GAAG,KAAKV,UAAhB;AACA,QAAIW,CAAqC,GAAG,IAA5C;;AAEA,WAAO,KAAKC,QAAL,IAAiB,CAAC,CAACD,CAAC,GAAG,MAAMd,EAAE,CAACgB,IAAH,EAAX,EAAsBC,IAA/C,EAAqD;AACnD,UAAIX,IAAI,KAAK,IAAb,EAAmB;AACjBA,QAAAA,IAAI,IAAIO,EAAE,IAAIK,WAAW,CAACC,MAAZ,CAAmBL,CAAC,CAACM,KAArB,CAAN,GAAoCN,CAAC,CAACM,KAAF,CAAQC,UAA5C,GAAyD,CAAjE;AACD;;AACD,UAAI,CAAC,KAAKC,IAAL,CAAU,IAAIC,UAAJ,CAAeT,CAAC,CAACM,KAAjB,CAAV,CAAD,IAAuCd,IAAI,IAAI,CAAnD,EAAsD;AACpD;AACD;AACF;;AACD,QAAI,CAAC,MAAAQ,CAAC,UAAD,wBAAGG,IAAH,IAAW,CAAC,KAAKF,QAAlB,MAAgC,KAAKO,IAAL,CAAU,IAAV,KAAmB,IAAnD,CAAJ,EAA8D;AAAA;;AAC5DtB,MAAAA,EAAE,SAAF,IAAAA,EAAE,WAAF,0BAAAA,EAAE,CAAEY,MAAJ,+DAAAZ,EAAE;AACH;;AACD,WAAO,CAAC,KAAKe,QAAb;AACD;;AAhD0C;;AAsD7C,eAAevB,cAAf","sourcesContent":["import {Readable, ReadableOptions} from 'stream';\r\n\r\nexport type MakeNodeStreamOptions = ReadableOptions;\r\n\r\n/** Builds a node stream from an iterator */\r\nfunction makeNodeStream<ArrayBuffer>(\r\n  source: Iterable<ArrayBuffer> | AsyncIterable<ArrayBuffer>,\r\n  options?: ReadableOptions\r\n): Readable {\r\n  const iterator = source[Symbol.asyncIterator]\r\n    ? source[Symbol.asyncIterator]()\r\n    : source[Symbol.iterator]();\r\n  return new AsyncIterableReadable(iterator, options);\r\n}\r\n\r\nclass AsyncIterableReadable extends Readable {\r\n  private _pulling: boolean;\r\n  private _bytesMode: boolean;\r\n  private _iterator: AsyncIterator<ArrayBuffer>;\r\n\r\n  constructor(it: AsyncIterator<ArrayBuffer>, options?: ReadableOptions) {\r\n    super(options);\r\n    this._iterator = it;\r\n    this._pulling = false;\r\n    this._bytesMode = !options || !options.objectMode;\r\n  }\r\n\r\n  async _read(size: number): Promise<void> {\r\n    if (!this._pulling) {\r\n      this._pulling = true;\r\n      this._pulling = await this._pull(size, this._iterator);\r\n    }\r\n  }\r\n\r\n  async _destroy(error: Error | null, cb: (e: Error | null) => void): Promise<void> {\r\n    if (!this._iterator) {\r\n      return;\r\n    }\r\n    if (error) {\r\n      await this._iterator?.throw?.(error);\r\n    } else {\r\n      await this._iterator?.return?.(error);\r\n    }\r\n    cb?.(null);\r\n  }\r\n\r\n  // eslint-disable-next-line complexity\r\n  private async _pull(size: number, it: AsyncIterator<ArrayBuffer>): Promise<boolean> {\r\n    const bm = this._bytesMode;\r\n    let r: IteratorResult<ArrayBuffer> | null = null;\r\n    // while (this.readable && !(r = await it.next(bm ? size : null)).done) {\r\n    while (this.readable && !(r = await it.next()).done) {\r\n      if (size !== null) {\r\n        size -= bm && ArrayBuffer.isView(r.value) ? r.value.byteLength : 1;\r\n      }\r\n      if (!this.push(new Uint8Array(r.value)) || size <= 0) {\r\n        break;\r\n      }\r\n    }\r\n    if ((r?.done || !this.readable) && (this.push(null) || true)) {\r\n      it?.return?.();\r\n    }\r\n    return !this.readable;\r\n  }\r\n}\r\n\r\n// This module is marked `false` in the the \"browser\" field of the `package.json` for\r\n// `@loaders.gl/core`. We avoid using named exports so that bundlers have an easier\r\n// time resolving this \"empty\" module.\r\nexport default makeNodeStream;\r\n"],"file":"make-node-stream.js"}