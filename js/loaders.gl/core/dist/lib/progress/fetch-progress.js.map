{"version":3,"sources":["../../../src/lib/progress/fetch-progress.ts"],"names":["fetchProgress","response","onProgress","onDone","onError","ok","body","contentLength","headers","get","totalBytes","parseInt","ReadableStream","getReader","progressStream","start","controller","reader","read","Response","loadedBytes","done","value","close","byteLength","percent","Math","round","enqueue","error"],"mappings":"AAKA,eAAe,eAAeA,aAAf,CACbC,QADa,EAEbC,UAFa,EAGbC,MAAM,GAAG,MAAM,CAAE,CAHJ,EAIbC,OAAO,GAAG,MAAM,CAAE,CAJL,EAKb;AACAH,EAAAA,QAAQ,GAAG,MAAMA,QAAjB;;AACA,MAAI,CAACA,QAAQ,CAACI,EAAd,EAAkB;AAEhB,WAAOJ,QAAP;AACD;;AACD,QAAMK,IAAI,GAAGL,QAAQ,CAACK,IAAtB;;AACA,MAAI,CAACA,IAAL,EAAW;AAET,WAAOL,QAAP;AACD;;AACD,QAAMM,aAAa,GAAGN,QAAQ,CAACO,OAAT,CAAiBC,GAAjB,CAAqB,gBAArB,KAA0C,CAAhE;AACA,QAAMC,UAAU,GAAGH,aAAa,IAAII,QAAQ,CAACJ,aAAD,CAA5C;;AACA,MAAI,EAAEA,aAAa,GAAG,CAAlB,CAAJ,EAA0B;AACxB,WAAON,QAAP;AACD;;AAED,MAAI,OAAOW,cAAP,KAA0B,WAA1B,IAAyC,CAACN,IAAI,CAACO,SAAnD,EAA8D;AAC5D,WAAOZ,QAAP;AACD;;AAGD,QAAMa,cAAc,GAAG,IAAIF,cAAJ,CAAmB;AACxC,UAAMG,KAAN,CAAYC,UAAZ,EAAwB;AACtB,YAAMC,MAAM,GAAGX,IAAI,CAACO,SAAL,EAAf;AACA,YAAMK,IAAI,CAACF,UAAD,EAAaC,MAAb,EAAqB,CAArB,EAAwBP,UAAxB,EAAoCR,UAApC,EAAgDC,MAAhD,EAAwDC,OAAxD,CAAV;AACD;;AAJuC,GAAnB,CAAvB;AAOA,SAAO,IAAIe,QAAJ,CAAaL,cAAb,CAAP;AACD;;AAKD,eAAeI,IAAf,CAAoBF,UAApB,EAAgCC,MAAhC,EAAwCG,WAAxC,EAAqDV,UAArD,EAAiER,UAAjE,EAA6EC,MAA7E,EAAqFC,OAArF,EAA8F;AAC5F,MAAI;AACF,UAAM;AAACiB,MAAAA,IAAD;AAAOC,MAAAA;AAAP,QAAgB,MAAML,MAAM,CAACC,IAAP,EAA5B;;AACA,QAAIG,IAAJ,EAAU;AACRlB,MAAAA,MAAM;AACNa,MAAAA,UAAU,CAACO,KAAX;AACA;AACD;;AACDH,IAAAA,WAAW,IAAIE,KAAK,CAACE,UAArB;AACA,UAAMC,OAAO,GAAGC,IAAI,CAACC,KAAL,CAAYP,WAAW,GAAGV,UAAf,GAA6B,GAAxC,CAAhB;AACAR,IAAAA,UAAU,CAACuB,OAAD,EAAU;AAACL,MAAAA,WAAD;AAAcV,MAAAA;AAAd,KAAV,CAAV;AACAM,IAAAA,UAAU,CAACY,OAAX,CAAmBN,KAAnB;AACA,UAAMJ,IAAI,CAACF,UAAD,EAAaC,MAAb,EAAqBG,WAArB,EAAkCV,UAAlC,EAA8CR,UAA9C,EAA0DC,MAA1D,EAAkEC,OAAlE,CAAV;AACD,GAZD,CAYE,OAAOyB,KAAP,EAAc;AACdb,IAAAA,UAAU,CAACa,KAAX,CAAiBA,KAAjB;AACAzB,IAAAA,OAAO,CAACyB,KAAD,CAAP;AACD;AACF","sourcesContent":["// Forked from github AnthumChris/fetch-progress-indicators under MIT license\r\n\r\n/**\r\n * Intercepts the Response stream and creates a new Response\r\n */\r\nexport default async function fetchProgress(\r\n  response: Response | Promise<Response>,\r\n  onProgress: any, // TODO better callback types\r\n  onDone = () => {},\r\n  onError = () => {}\r\n) {\r\n  response = await response;\r\n  if (!response.ok) {\r\n    // ERROR checking needs to be done separately\r\n    return response;\r\n  }\r\n  const body = response.body;\r\n  if (!body) {\r\n    // 'ReadableStream not yet supported in this browser.\r\n    return response;\r\n  }\r\n  const contentLength = response.headers.get('content-length') || 0;\r\n  const totalBytes = contentLength && parseInt(contentLength);\r\n  if (!(contentLength > 0)) {\r\n    return response;\r\n  }\r\n  // Currently override only implemented in browser\r\n  if (typeof ReadableStream === 'undefined' || !body.getReader) {\r\n    return response;\r\n  }\r\n\r\n  // Create a new stream that invisbly wraps original stream\r\n  const progressStream = new ReadableStream({\r\n    async start(controller) {\r\n      const reader = body.getReader();\r\n      await read(controller, reader, 0, totalBytes, onProgress, onDone, onError);\r\n    }\r\n  });\r\n\r\n  return new Response(progressStream);\r\n}\r\n\r\n// Forward to original streams controller\r\n// TODO - this causes a crazy deep \"async stack\"... rewrite as async iterator?\r\n// eslint-disable-next-line max-params\r\nasync function read(controller, reader, loadedBytes, totalBytes, onProgress, onDone, onError) {\r\n  try {\r\n    const {done, value} = await reader.read();\r\n    if (done) {\r\n      onDone();\r\n      controller.close();\r\n      return;\r\n    }\r\n    loadedBytes += value.byteLength;\r\n    const percent = Math.round((loadedBytes / totalBytes) * 100);\r\n    onProgress(percent, {loadedBytes, totalBytes});\r\n    controller.enqueue(value);\r\n    await read(controller, reader, loadedBytes, totalBytes, onProgress, onDone, onError);\r\n  } catch (error) {\r\n    controller.error(error);\r\n    onError(error);\r\n  }\r\n}\r\n"],"file":"fetch-progress.js"}