{"version":3,"sources":["../../../src/lib/loader-utils/option-utils.ts"],"names":["global","isPureObject","isObject","fetchFile","probeLog","NullLog","DEFAULT_LOADER_OPTIONS","REMOVED_LOADER_OPTIONS","getGlobalLoaderState","loaders","_state","getGlobalLoaderOptions","state","globalOptions","setGlobalOptions","options","normalizeOptionsInternal","normalizeOptions","loader","url","Array","isArray","validateOptions","getFetchFunction","context","fetchOptions","fetch","validateOptionsObject","idOptions","id","loaderOptions","deprecatedOptions","defaultOptions","loaderName","prefix","key","isSubOptions","isBaseUriOption","isWorkerUrlOption","warn","suggestion","findSimilarOption","optionKey","lowerCaseOptionKey","toLowerCase","bestSuggestion","lowerCaseKey","isPartialMatch","startsWith","loaderDefaultOptions","mergedOptions","addUrlOptions","log","mergeNestedFields","value","baseUri"],"mappings":"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","sourcesContent":["import type {Loader, LoaderContext, LoaderOptions} from '@loaders.gl/loader-utils';\r\nimport {global} from '@loaders.gl/loader-utils';\r\nimport {isPureObject, isObject} from '../../javascript-utils/is-type';\r\nimport {fetchFile} from '../fetch/fetch-file';\r\nimport {probeLog, NullLog} from './loggers';\r\nimport {DEFAULT_LOADER_OPTIONS, REMOVED_LOADER_OPTIONS} from './option-defaults';\r\n/**\r\n * Global state for loaders.gl. Stored on `global.loaders._state`\r\n */\r\ntype GlobalLoaderState = {\r\n  loaderRegistry: Loader[];\r\n  globalOptions: {[key: string]: any};\r\n};\r\n\r\n/**\r\n * Helper for safely accessing global loaders.gl variables\r\n * Wraps initialization of global variable in function to defeat overly aggressive tree-shakers\r\n */\r\nexport function getGlobalLoaderState(): GlobalLoaderState {\r\n  // @ts-ignore\r\n  global.loaders = global.loaders || {};\r\n  // @ts-ignore\r\n  const {loaders} = global;\r\n\r\n  // Add _state object to keep separate from modules added to global.loaders\r\n  loaders._state = loaders._state || {};\r\n  return loaders._state;\r\n}\r\n\r\n// Store global loader options on the global object to increase chances of cross loaders-version interoperability\r\n// NOTE: This use case is not reliable but can help when testing new versions of loaders.gl with existing frameworks\r\nconst getGlobalLoaderOptions = () => {\r\n  const state = getGlobalLoaderState();\r\n  // Ensure all default loader options from this library are mentioned\r\n  state.globalOptions = state.globalOptions || {...DEFAULT_LOADER_OPTIONS};\r\n  return state.globalOptions;\r\n};\r\n\r\n/**\r\n * Set global loader options\r\n * @param options\r\n */\r\nexport function setGlobalOptions(options: object): void {\r\n  const state = getGlobalLoaderState();\r\n  const globalOptions = getGlobalLoaderOptions();\r\n  state.globalOptions = normalizeOptionsInternal(globalOptions, options);\r\n}\r\n\r\n/**\r\n * Merges options with global opts and loader defaults, also injects baseUri\r\n * @param options\r\n * @param loader\r\n * @param loaders\r\n * @param url\r\n */\r\nexport function normalizeOptions(\r\n  options: object,\r\n  loader: Loader,\r\n  loaders?: Loader[],\r\n  url?: string\r\n): object {\r\n  loaders = loaders || [];\r\n  loaders = Array.isArray(loaders) ? loaders : [loaders];\r\n\r\n  validateOptions(options, loaders);\r\n  return normalizeOptionsInternal(loader, options, url);\r\n}\r\n\r\n/**\r\n * Gets the current fetch function from options and context\r\n * @param options\r\n * @param context\r\n */\r\nexport function getFetchFunction(\r\n  options?: LoaderOptions,\r\n  context?: Omit<LoaderContext, 'fetch'> & Partial<Pick<LoaderContext, 'fetch'>>\r\n) {\r\n  const globalOptions = getGlobalLoaderOptions();\r\n\r\n  const fetchOptions = options || globalOptions;\r\n\r\n  // options.fetch can be a function\r\n  if (typeof fetchOptions.fetch === 'function') {\r\n    return fetchOptions.fetch;\r\n  }\r\n\r\n  // options.fetch can be an options object\r\n  if (isObject(fetchOptions.fetch)) {\r\n    return (url) => fetchFile(url, fetchOptions);\r\n  }\r\n\r\n  // else refer to context (from parent loader) if available\r\n  if (context?.fetch) {\r\n    return context?.fetch;\r\n  }\r\n\r\n  // else return the default fetch function\r\n  return fetchFile;\r\n}\r\n\r\n// VALIDATE OPTIONS\r\n\r\n/**\r\n * Warn for unsupported options\r\n * @param options\r\n * @param loaders\r\n */\r\nfunction validateOptions(options: LoaderOptions, loaders: Loader[]) {\r\n  // Check top level options\r\n  validateOptionsObject(options, null, DEFAULT_LOADER_OPTIONS, REMOVED_LOADER_OPTIONS, loaders);\r\n  for (const loader of loaders) {\r\n    // Get the scoped, loader specific options from the user supplied options\r\n    const idOptions = (options && options[loader.id]) || {};\r\n\r\n    // Get scoped, loader specific default and deprecated options from the selected loader\r\n    const loaderOptions = (loader.options && loader.options[loader.id]) || {};\r\n    const deprecatedOptions =\r\n      (loader.deprecatedOptions && loader.deprecatedOptions[loader.id]) || {};\r\n\r\n    // Validate loader specific options\r\n    validateOptionsObject(idOptions, loader.id, loaderOptions, deprecatedOptions, loaders);\r\n  }\r\n}\r\n\r\n// eslint-disable-next-line max-params, complexity\r\nfunction validateOptionsObject(\r\n  options,\r\n  id: string | null,\r\n  defaultOptions,\r\n  deprecatedOptions,\r\n  loaders: Loader[]\r\n) {\r\n  const loaderName = id || 'Top level';\r\n  const prefix = id ? `${id}.` : '';\r\n\r\n  for (const key in options) {\r\n    // If top level option value is an object it could options for a loader, so ignore\r\n    const isSubOptions = !id && isObject(options[key]);\r\n    const isBaseUriOption = key === 'baseUri' && !id;\r\n    const isWorkerUrlOption = key === 'workerUrl' && id;\r\n    // <loader>.workerUrl requires special handling as it is now auto-generated and no longer specified as a default option.\r\n    if (!(key in defaultOptions) && !isBaseUriOption && !isWorkerUrlOption) {\r\n      // Issue deprecation warnings\r\n      if (key in deprecatedOptions) {\r\n        probeLog.warn(\r\n          `${loaderName} loader option \\'${prefix}${key}\\' no longer supported, use \\'${deprecatedOptions[key]}\\'`\r\n        )();\r\n      } else if (!isSubOptions) {\r\n        const suggestion = findSimilarOption(key, loaders);\r\n        probeLog.warn(\r\n          `${loaderName} loader option \\'${prefix}${key}\\' not recognized. ${suggestion}`\r\n        )();\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction findSimilarOption(optionKey, loaders) {\r\n  const lowerCaseOptionKey = optionKey.toLowerCase();\r\n  let bestSuggestion = '';\r\n  for (const loader of loaders) {\r\n    for (const key in loader.options) {\r\n      if (optionKey === key) {\r\n        return `Did you mean \\'${loader.id}.${key}\\'?`;\r\n      }\r\n      const lowerCaseKey = key.toLowerCase();\r\n      const isPartialMatch =\r\n        lowerCaseOptionKey.startsWith(lowerCaseKey) || lowerCaseKey.startsWith(lowerCaseOptionKey);\r\n      if (isPartialMatch) {\r\n        bestSuggestion = bestSuggestion || `Did you mean \\'${loader.id}.${key}\\'?`;\r\n      }\r\n    }\r\n  }\r\n  return bestSuggestion;\r\n}\r\n\r\nfunction normalizeOptionsInternal(loader, options, url?: string) {\r\n  const loaderDefaultOptions = loader.options || {};\r\n\r\n  const mergedOptions = {...loaderDefaultOptions};\r\n\r\n  addUrlOptions(mergedOptions, url);\r\n\r\n  // LOGGING: options.log can be set to `null` to defeat logging\r\n  if (mergedOptions.log === null) {\r\n    mergedOptions.log = new NullLog();\r\n  }\r\n\r\n  mergeNestedFields(mergedOptions, getGlobalLoaderOptions());\r\n  mergeNestedFields(mergedOptions, options);\r\n\r\n  return mergedOptions;\r\n}\r\n\r\n// Merge nested options objects\r\nfunction mergeNestedFields(mergedOptions, options) {\r\n  for (const key in options) {\r\n    // Check for nested options\r\n    // object in options => either no key in defaultOptions or object in defaultOptions\r\n    if (key in options) {\r\n      const value = options[key];\r\n      if (isPureObject(value) && isPureObject(mergedOptions[key])) {\r\n        mergedOptions[key] = {\r\n          ...mergedOptions[key],\r\n          ...options[key]\r\n        };\r\n      } else {\r\n        mergedOptions[key] = options[key];\r\n      }\r\n    }\r\n    // else: No need to merge nested opts, and the initial merge already copied over the nested options\r\n  }\r\n}\r\n\r\n// Harvest information from the url\r\n// TODO - baseUri should be a directory, i.e. remove file component from baseUri\r\n// TODO - extract extension?\r\n// TODO - extract query parameters?\r\n// TODO - should these be injected on context instead of options?\r\nfunction addUrlOptions(options, url?: string) {\r\n  if (url && !('baseUri' in options)) {\r\n    options.baseUri = url;\r\n  }\r\n}\r\n"],"file":"option-utils.js"}